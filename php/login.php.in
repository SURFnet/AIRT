<?php
/* $Id$
 * login.php - allows users to log in to this site. 
 *
 * AIRT: APPLICATION FOR INCIDENT RESPONSE TEAMS
 * Copyright (C) 2004	Tilburg University, The Netherlands

 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
$public=1;
require_once 'config.plib';
require_once LIBDIR."/authentication.plib";
require_once LIBDIR."/airt.plib";

if (array_key_exists('action', $_REQUEST)) $action=$_REQUEST['action'];
else $action = "none";

switch ($action) {
    case "none":
        pageHeader("AIRT login page");
        echo <<<EOF
<P>
<form action="$_SERVER[PHP_SELF]" method="POST">
<table>
<tr>
    <td>Login</td>
    <td><input type="text"  name="login" size="25"></td>
</tr>

<tr>
    <td>Password</td>
    <td><input type="password"  name="password" size="25"></td>
</tr>
</table>

<P>
<input type="hidden" name="action" value="check">
<input type="submit" value="Login">
</form>

<P>
<HR>
<P>
<BLOCKQUOTE><small>
    AIRT version @VERSION@, Copyright (C) 2004-2005 Tilburg University
    &lt;<a href="mailto:kees@uvt.nl">kees@uvt.nl</a>&gt;<BR>
    AIR comes with ABSOLUTELY NO WARRANTY; for details 
    <a href="license.php">click here</a>.<BR>
    This is free software, and you are welcome to redistribute it
    under certain conditions; See the license for more details.
</small></BLOCKQUOTE>
EOF;
		generateEvent('loginscreen');
        break;


    case "check":
        if (array_key_exists("login", $_REQUEST))
            $login = $_REQUEST["login"];
        else die("Missing required field.");

        // password must be HTTP post
        if (array_key_exists("password", $_POST))
            $password = $_POST["password"];
        else die("Missing required field.");

        $userid = airt_authenticate($login, $password);
        if ($userid == -1) {
            pageHeader("Permission denied.");
			generateEvent("invalidlogin", array(
				"login" => $login,
				"remoteip" => $_SERVER['REMOTE_ADDR']
			));
            printf("Username and/or password incorrect.");
            pageFooter();
            exit;
        }

		airt_initsession($userid);

        Header("Location: index.php");

        break;

    default:
        die("Unknown action.");
} // switch
?>
